# Single Point of Management Plan (SPMP) - 2025-07-01

This document consolidates all identified unfinished features and implementations from various project documentation files. It serves as a centralized reference for the ongoing development roadmap.

---

## 1. Foundational Tooling & Infrastructure

### 1.1. Database Migrations
- **Status**: Completed.
- **Action**: Ensure all future database schema modifications are managed via `flask db migrate` and `flask db upgrade`.

### 1.2. Testing Framework
- **Status**: Completed.
- **Action**: Continuously write comprehensive unit, integration, and functional tests for new and existing features to ensure code stability and prevent regressions.

---

## 2. Security Hardening & Compliance

### 2.1. Security Hardening
- **CSRF Protection for AJAX Requests**:
    - **Status**: Completed.
    - **Implementation**: Verified that `app/static/js/progress/export.js` correctly includes CSRF token in POST requests. Other JavaScript files do not make unprotected AJAX POST requests. The `meta[name="csrf-token"]` tag is correctly present in `base.html`.
- **Rate Limiting**:
    - **Status**: Completed.
    - **Action**: Applied comprehensive rate limits to all sensitive blueprints (`auth`, `diary`, `goals`, `user`, `progress`, `reader`) in `routes/__init__.py`. Added a new test file `tests/test_security.py` to verify the implementation.
- **Dependency Security Audit**:
    - **Status**: Completed.
    - **Implementation**: `safety check` and `pip-audit` performed. Identified `pillow` vulnerability (PYSEC-2025-61) and upgraded `pillow` to `11.3.0`. All known vulnerabilities addressed.

### 2.2. Legal & Compliance (GDPR Focus)
- **Privacy Policy and Cookie Consent**:
    - **Status**: Completed.
    - **Implementation**: Content of `privacy.html` and `terms.html` updated to accurately reflect existing features and GDPR compliance. Cookie consent mechanism in `cookie_consent.js` verified to be sufficient for essential cookies.
- **User Data Deletion (Right to Erasure)**:
    - **Status**: Completed.
    - **Implementation**: Existing test suite (`tests/test_routes/test_user.py`) thoroughly verifies that the "Delete Account" feature performs a full cascading delete of all associated user data.
- **Data Portability**:
    - **Status**: Completed.
    - **Action**: Verify the completeness and accuracy of exported data for all user-related information.

---

## 3. Code Quality & Refactoring

### 3.1. Project Structure and File Naming
- **Status**: Completed.
- **Action**:
    - Create an `app` directory and move core application files (`config.py`, `models/`, `routes/`, `static/`, `templates/`, `utils/`) into it. Rename `app.py` to `run.py` in the root.
    - Complete renaming of all files and directories to `snake_case` (e.g., `custom_css.css` to `main.css`, `read_diary.html` to `reader.html`).
    - Update `GEMINI.md` to reflect the final project structure and file names.

### 3.2. Python Code Style
- **Status**: Completed.
- **Implementation**: 
    - Applied `black` code formatter to the entire project (41 files reformatted).
    - Confirmed all variables and functions already follow `snake_case` convention.
    - Added comprehensive type hints to all function definitions across routes, models, forms, and utilities.
    - Converted existing docstrings to Google-style format with proper Args/Returns sections.
    - Created `pyproject.toml` configuration for black and isort.
    - All 120 tests pass with new code style improvements.

### 3.3. Route and Helper Organization
- **Status**: In Progress.
- **Action**:
    - Create feature-based route packages (e.g., `app/routes/auth/`, `app/routes/diary/`) with `__init__.py`, `routes.py`, and `helpers.py` files.
    - Move route logic and helper functions into their respective feature packages.
    - Update all imports throughout the application to reflect the new locations.

### 3.4. Static and Template File Organization
- **Status**: In Progress.
- **Action**:
    - Organize CSS and JavaScript files more granularly by feature within `static/css/` and `static/js/`.
    - Organize HTML templates into feature-based subdirectories within `templates/`.
    - Update all `url_for()` and `render_template()` calls to point to the new file locations.

### 3.5. HTML and JavaScript Style
- **Status**: In Progress.
- **Action**:
    - Update all HTML `id` and custom `data-*` attributes from `kebab-case` or `camelCase` to `snake_case`.
    - Refactor all JavaScript variable and function names from `camelCase` to `snake_case`.

### 3.6. Database Refactoring
- **Status**: Completed.
- **Implementation**: 
    - Updated SQLAlchemy model definitions to use `snake_case` and plural for table names: `user` → `users`, `goal` → `goals`.
    - Created dual-database compatible migration script (`migrations/versions/033faf89f4e5_*`) that handles both SQLite (development) and PostgreSQL (production).
    - Applied database migration successfully to rename tables without data loss in both environments.
    - Updated all foreign key references in models: `'user.id'` → `'users.id'`.
    - Verified migration works correctly on Railway PostgreSQL production database.
    - All 120 tests pass with new schema structure.

### 3.7. Final Review and Cleanup
- **Status**: Not Started.
- **Action**:
    - Run all tests to ensure no functionality is broken.
    - Conduct a final review of the entire codebase for consistency with the style guide.
    - Remove any empty or unused files and directories.
    - Update `README.md` to reflect the new project structure and setup instructions.

---

## 4. Technical Debt & Performance

### 4.1. Database Performance
- **Status**: Not Started.
- **Action**: Add explicit database indexes to frequently queried columns (e.g., foreign keys, date columns) to improve read query performance.

### 4.2. Centralize Flash Message Handling
- **Status**: Partially Completed.
- **Action**: Consider centralizing the logic for `flash` messages into a helper function or dedicated utility for consistency and easier management.

### 4.3. Review Datetime Usage for Consistency
- **Status**: Partially Completed.
- **Action**: Review all instances of `datetime.now().date()` and `date.today()` to ensure consistent and appropriate use, especially concerning timezone awareness for date-only comparisons.

---

## 5. User Experience Improvements

- **Status**: Identified as future improvements.
- **Action**: Implement:
    - Email verification and password reset functionality.
    - Dark/light mode toggle.
    - Onboarding tour for new users.
    - Clickable "points today" to see detailed point breakdown.
    - Clickable "opportunities for growth" and "keep doing this" to see corresponding diary entries.
    - An "About" page.
